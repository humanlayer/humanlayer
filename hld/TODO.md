# HumanLayer Daemon (HLD) - TODO

## 錯誤

## 功能（已規劃）

### 對話歷史批次端點

**目標**：減少 TUI 訊息計數顯示的 N+1 問題
**目前問題**：TUI 需要為每個 session 分別呼叫 `GetConversation` 來計算訊息數
**建議解決方案**：新增批次端點，為多個 session 回傳對話中繼資料（訊息計數、最後訊息等）
**替代方案**：擴充 `ListSessions` 以包含對話中繼資料
**效能影響**：將顯著改善 TUI session 列表的載入時間
**檔案**：`rpc/handlers.go`（新端點）、`rpc/types.go`（新類型）
**優先級**：中 - 可在不影響效能的情況下啟用 TUI 訊息計數功能

### Session 狀態即時更新

**目標**：確保 session 狀態準確反映目前狀態，包括核准阻塞
**目前限制**：當 session 被核准阻塞時，狀態可能不會更新
**實作方式**：改善核准系統與 session 管理器之間的狀態傳播
**檔案**：`approval/manager.go`、`session/manager.go`、事件匯流排整合
**相依性**：可能需要改進事件匯流排以實現跨元件通訊
**優先級**：高 - 準確的狀態對使用者理解至關重要

### Session 全文搜尋

**目標**：讓 TUI 能夠搜尋 session 內容，而不僅僅是中繼資料
**實作方式**：為對話內容新增搜尋索引
**考量事項**：

- SQLite FTS（全文搜尋）擴充功能
- Elasticsearch/類似工具用於進階搜尋
- 簡單的 LIKE 查詢用於基本搜尋
  **效能**：需要在建立/更新時對對話內容建立索引
  **檔案**：`store/sqlite.go`（搜尋方法）、`rpc/handlers.go`（搜尋端點）
  **優先級**：低 - 實作複雜，初期使用者需求不明確

### 增強的 Session 指標

**目標**：為 TUI 顯示提供更詳細的 session 分析
**目前資料**：基本成本、token 計數、持續時間
**額外指標**：

- 按類型分類的工具呼叫計數
- 核准回應時間
- Session 複雜度分數
- 資源使用模式
  **儲存**：可以擴充 session 儲存或建立單獨的指標表
  **檔案**：`session/manager.go`（指標收集）、`store/sqlite.go`（指標儲存）
  **優先級**：低 - 對進階使用者來說是不錯的功能

### 對話匯出 API

**目標**：讓 TUI 能夠以各種格式匯出 session 資料
**格式**：JSON、CSV、Markdown 對話日誌
**實作方式**：新的 RPC 端點用於資料匯出
**考量事項**：

- 大型對話處理
- 串流與批次匯出
- 格式特定處理
  **檔案**：`rpc/handlers.go`（匯出端點）、可能需要新的匯出套件
  **優先級**：低 - 使用者目前可以透過其他方式存取資料

### 批次 Session 操作

**目標**：支援對 session 進行批次操作（刪除、封存等）
**目前限制**：僅支援單一 session 操作
**使用案例**：清理、批次處理、管理操作
**實作方式**：新的 RPC 端點用於批次操作，並支援交易
**檔案**：`rpc/handlers.go`（批次端點）、`session/manager.go`（批次操作）
**優先級**：低 - 單一操作對大多數初期使用案例已足夠

## 技術債務

### 事件匯流排改進

**目標**：更好的跨元件通訊以進行狀態更新
**目前限制**：核准和 session 系統之間的事件傳播有限
**需要改進的地方**：

- 更細緻的事件類型
- 更好的事件處理錯誤處理
- 事件持久化/重播以提高可靠性
  **檔案**：`bus/events.go`、`approval/` 和 `session/` 中的整合點
  **優先級**：中 - 可以解決幾個狀態更新問題

### 資料庫結構最佳化

**目標**：為不斷增長的 session 資料最佳化查詢和儲存
**改進領域**：

- 常見查詢的索引最佳化
- 對話儲存效率
- Session 中繼資料正規化
  **工具**：SQLite ANALYZE、查詢效能分析
  **檔案**：`store/sqlite.go`、可能需要遷移腳本
  **優先級**：低 - 目前效能對預期規模可接受

### 錯誤處理標準化

**目標**：所有 RPC 端點的一致錯誤回應
**目前問題**：不一致的錯誤格式使除錯更困難
**實作方式**：標準化錯誤類型和回應格式
**檔案**：`rpc/handlers.go`、`rpc/types.go`（錯誤類型）
**優先級**：低 - 功能正常但可以改善開發者體驗

## 未來功能

### WebSocket/串流支援

**目標**：為活動 session 提供即時更新，而不是輪詢
**目前限制**：TUI 每 3 秒輪詢一次更新
**實作方式**：WebSocket 或 Server-Sent Events 用於即時更新
**複雜度**：高 - 需要重大架構變更
**優先級**：低 - 輪詢對目前規模運作良好

### 多使用者 Session 共享

**目標**：允許多個使用者協作處理 session
**實作方式**：Session 權限、使用者管理、協作編輯
**複雜度**：非常高 - 需要身份驗證、授權、衝突解決
**優先級**：非常低 - 目前專注於單一使用者

### Session 範本

**目標**：儲存和重複使用 session 配置
**實作方式**：範本儲存、範本管理 API
**檔案**：新的範本儲存、`rpc/handlers.go`（範本端點）
**優先級**：低 - 初期可以在客戶端實作

### 進階分析

**目標**：使用模式、效能分析、最佳化見解
**實作方式**：分析收集、彙總、報告 API
**隱私考量**：要收集哪些資料、保留政策
**優先級**：非常低 - 初期基本指標已足夠
